{
  "$defs": {
    "AgentNode": {
      "additionalProperties": false,
      "description": "A node that calls a specific atomic agent.\n\nAttributes:\n    type: The type of the node (must be 'agent').\n    agent_name: The name of the atomic agent to call.\n    system_prompt: Overrides the registry default prompt. Required for ad-hoc/optimized agents.\n    config: Runtime-specific configuration (e.g., model parameters, temperature). Merged with registry defaults.\n    overrides: Runtime overrides for the agent (e.g., temperature, prompt_template_vars).",
      "properties": {
        "id": {
          "description": "Unique identifier for the node.",
          "title": "Id",
          "type": "string"
        },
        "council_config": {
          "anyOf": [
            {
              "$ref": "#/$defs/CouncilConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional configuration for architectural triangulation."
        },
        "visual": {
          "anyOf": [
            {
              "$ref": "#/$defs/VisualMetadata"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Visual metadata for the UI."
        },
        "metadata": {
          "additionalProperties": true,
          "description": "Generic metadata for operational context (e.g. cost tracking, SLAs).",
          "title": "Metadata",
          "type": "object"
        },
        "type": {
          "const": "agent",
          "default": "agent",
          "description": "Discriminator for AgentNode.",
          "title": "Type",
          "type": "string"
        },
        "agent_name": {
          "description": "The name of the atomic agent to call.",
          "title": "Agent Name",
          "type": "string"
        },
        "system_prompt": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Overrides the registry default prompt. Required for ad-hoc/optimized agents.",
          "title": "System Prompt"
        },
        "config": {
          "anyOf": [
            {
              "additionalProperties": true,
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Runtime-specific configuration (e.g., model parameters, temperature). Merged with registry defaults.",
          "title": "Config"
        },
        "overrides": {
          "anyOf": [
            {
              "additionalProperties": true,
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Runtime overrides for the agent (e.g., temperature, prompt_template_vars).",
          "title": "Overrides"
        }
      },
      "required": [
        "id",
        "agent_name"
      ],
      "title": "AgentNode",
      "type": "object"
    },
    "ConditionalEdge": {
      "additionalProperties": false,
      "description": "Represents a dynamic routing connection from one node to multiple potential targets.\n\nAttributes:\n    source_node_id: The ID of the source node.\n    router_logic: A reference to a python function or a logic expression that returns the next node ID.\n    mapping: A dictionary mapping the router's output (e.g., \"approve\", \"reject\") to target Node IDs.",
      "properties": {
        "source_node_id": {
          "description": "The ID of the source node.",
          "title": "Source Node Id",
          "type": "string"
        },
        "router_logic": {
          "anyOf": [
            {
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*(\\.[a-zA-Z_][a-zA-Z0-9_]*)*$",
              "type": "string"
            },
            {
              "$ref": "#/$defs/RouterExpression"
            }
          ],
          "description": "A reference to a python function or logic expression that determines the path.",
          "title": "Router Logic"
        },
        "mapping": {
          "additionalProperties": {
            "type": "string"
          },
          "description": "Map of router output values to target node IDs.",
          "title": "Mapping",
          "type": "object"
        }
      },
      "required": [
        "source_node_id",
        "router_logic",
        "mapping"
      ],
      "title": "ConditionalEdge",
      "type": "object"
    },
    "CouncilConfig": {
      "additionalProperties": false,
      "description": "Configuration for 'Architectural Triangulation'.\n\nAttributes:\n    strategy: The strategy for the council (e.g., 'consensus').\n    voters: List of agents or models that vote.",
      "properties": {
        "strategy": {
          "default": "consensus",
          "description": "The strategy for the council, e.g., 'consensus'.",
          "title": "Strategy",
          "type": "string"
        },
        "voters": {
          "description": "List of agents or models that vote.",
          "items": {
            "type": "string"
          },
          "title": "Voters",
          "type": "array"
        }
      },
      "required": [
        "voters"
      ],
      "title": "CouncilConfig",
      "type": "object"
    },
    "DataMapping": {
      "additionalProperties": false,
      "description": "Defines how to transform data between parent and child.",
      "properties": {
        "source": {
          "description": "The path/key source.",
          "title": "Source",
          "type": "string"
        },
        "strategy": {
          "$ref": "#/$defs/DataMappingStrategy",
          "default": "direct",
          "description": "The mapping strategy."
        }
      },
      "required": [
        "source"
      ],
      "title": "DataMapping",
      "type": "object"
    },
    "DataMappingStrategy": {
      "description": "Strategy for mapping data.",
      "enum": [
        "direct",
        "jsonpath",
        "literal"
      ],
      "title": "DataMappingStrategy",
      "type": "string"
    },
    "Edge": {
      "additionalProperties": false,
      "description": "Represents a connection between two nodes.\n\nAttributes:\n    source_node_id: The ID of the source node.\n    target_node_id: The ID of the target node.\n    condition: Optional Python expression for conditional branching.",
      "properties": {
        "source_node_id": {
          "description": "The ID of the source node.",
          "title": "Source Node Id",
          "type": "string"
        },
        "target_node_id": {
          "description": "The ID of the target node.",
          "title": "Target Node Id",
          "type": "string"
        },
        "condition": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional Python expression for conditional branching.",
          "title": "Condition"
        }
      },
      "required": [
        "source_node_id",
        "target_node_id"
      ],
      "title": "Edge",
      "type": "object"
    },
    "GraphTopology": {
      "additionalProperties": false,
      "description": "The topology definition of the recipe.\n\nAttributes:\n    nodes: List of nodes in the graph.\n    edges: List of edges connecting the nodes.\n    state_schema: Optional schema definition for the graph state.",
      "properties": {
        "nodes": {
          "description": "List of nodes in the graph.",
          "items": {
            "description": "Polymorphic node definition.",
            "discriminator": {
              "mapping": {
                "agent": "#/$defs/AgentNode",
                "human": "#/$defs/HumanNode",
                "logic": "#/$defs/LogicNode",
                "map": "#/$defs/MapNode",
                "recipe": "#/$defs/RecipeNode"
              },
              "propertyName": "type"
            },
            "oneOf": [
              {
                "$ref": "#/$defs/AgentNode"
              },
              {
                "$ref": "#/$defs/HumanNode"
              },
              {
                "$ref": "#/$defs/LogicNode"
              },
              {
                "$ref": "#/$defs/RecipeNode"
              },
              {
                "$ref": "#/$defs/MapNode"
              }
            ]
          },
          "title": "Nodes",
          "type": "array"
        },
        "edges": {
          "description": "List of edges connecting the nodes.",
          "items": {
            "anyOf": [
              {
                "$ref": "#/$defs/Edge"
              },
              {
                "$ref": "#/$defs/ConditionalEdge"
              }
            ]
          },
          "title": "Edges",
          "type": "array"
        },
        "state_schema": {
          "anyOf": [
            {
              "$ref": "#/$defs/StateDefinition"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Schema definition for the graph state."
        }
      },
      "required": [
        "nodes",
        "edges"
      ],
      "title": "GraphTopology",
      "type": "object"
    },
    "HumanNode": {
      "additionalProperties": false,
      "description": "A node that pauses execution for user input/approval.\n\nAttributes:\n    type: The type of the node (must be 'human').\n    timeout_seconds: Optional timeout in seconds for the user interaction.",
      "properties": {
        "id": {
          "description": "Unique identifier for the node.",
          "title": "Id",
          "type": "string"
        },
        "council_config": {
          "anyOf": [
            {
              "$ref": "#/$defs/CouncilConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional configuration for architectural triangulation."
        },
        "visual": {
          "anyOf": [
            {
              "$ref": "#/$defs/VisualMetadata"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Visual metadata for the UI."
        },
        "metadata": {
          "additionalProperties": true,
          "description": "Generic metadata for operational context (e.g. cost tracking, SLAs).",
          "title": "Metadata",
          "type": "object"
        },
        "type": {
          "const": "human",
          "default": "human",
          "description": "Discriminator for HumanNode.",
          "title": "Type",
          "type": "string"
        },
        "timeout_seconds": {
          "anyOf": [
            {
              "type": "integer"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional timeout in seconds for the user interaction.",
          "title": "Timeout Seconds"
        }
      },
      "required": [
        "id"
      ],
      "title": "HumanNode",
      "type": "object"
    },
    "LogicNode": {
      "additionalProperties": false,
      "description": "A node that executes pure Python logic.\n\nAttributes:\n    type: The type of the node (must be 'logic').\n    code: The Python logic code to execute.",
      "properties": {
        "id": {
          "description": "Unique identifier for the node.",
          "title": "Id",
          "type": "string"
        },
        "council_config": {
          "anyOf": [
            {
              "$ref": "#/$defs/CouncilConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional configuration for architectural triangulation."
        },
        "visual": {
          "anyOf": [
            {
              "$ref": "#/$defs/VisualMetadata"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Visual metadata for the UI."
        },
        "metadata": {
          "additionalProperties": true,
          "description": "Generic metadata for operational context (e.g. cost tracking, SLAs).",
          "title": "Metadata",
          "type": "object"
        },
        "type": {
          "const": "logic",
          "default": "logic",
          "description": "Discriminator for LogicNode.",
          "title": "Type",
          "type": "string"
        },
        "code": {
          "description": "The Python logic code to execute.",
          "title": "Code",
          "type": "string"
        }
      },
      "required": [
        "id",
        "code"
      ],
      "title": "LogicNode",
      "type": "object"
    },
    "MapNode": {
      "additionalProperties": false,
      "description": "A node that spawns multiple parallel executions of a sub-branch.\n\nAttributes:\n    type: The type of the node (must be 'map').\n    items_path: Dot-notation path to the list in the state.\n    processor_node_id: The node (or subgraph) to run for each item.\n    concurrency_limit: Max parallel executions.",
      "properties": {
        "id": {
          "description": "Unique identifier for the node.",
          "title": "Id",
          "type": "string"
        },
        "council_config": {
          "anyOf": [
            {
              "$ref": "#/$defs/CouncilConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional configuration for architectural triangulation."
        },
        "visual": {
          "anyOf": [
            {
              "$ref": "#/$defs/VisualMetadata"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Visual metadata for the UI."
        },
        "metadata": {
          "additionalProperties": true,
          "description": "Generic metadata for operational context (e.g. cost tracking, SLAs).",
          "title": "Metadata",
          "type": "object"
        },
        "type": {
          "const": "map",
          "default": "map",
          "description": "Discriminator for MapNode.",
          "title": "Type",
          "type": "string"
        },
        "items_path": {
          "description": "Dot-notation path to the list in the state.",
          "title": "Items Path",
          "type": "string"
        },
        "processor_node_id": {
          "description": "The node (or subgraph) to run for each item.",
          "title": "Processor Node Id",
          "type": "string"
        },
        "concurrency_limit": {
          "description": "Max parallel executions.",
          "title": "Concurrency Limit",
          "type": "integer"
        }
      },
      "required": [
        "id",
        "items_path",
        "processor_node_id",
        "concurrency_limit"
      ],
      "title": "MapNode",
      "type": "object"
    },
    "RecipeInterface": {
      "additionalProperties": false,
      "description": "Defines the input/output contract for a Recipe.\n\nAttributes:\n    inputs: JSON Schema defining valid entry arguments.\n    outputs: JSON Schema defining the guaranteed structure of the final result.",
      "properties": {
        "inputs": {
          "additionalProperties": true,
          "description": "JSON Schema defining valid entry arguments.",
          "title": "Inputs",
          "type": "object"
        },
        "outputs": {
          "additionalProperties": true,
          "description": "JSON Schema defining the guaranteed structure of the final result.",
          "title": "Outputs",
          "type": "object"
        }
      },
      "required": [
        "inputs",
        "outputs"
      ],
      "title": "RecipeInterface",
      "type": "object"
    },
    "RecipeNode": {
      "additionalProperties": false,
      "description": "A node that executes another Recipe as a sub-graph.\n\nAttributes:\n    type: The type of the node (must be 'recipe').\n    recipe_id: The ID of the recipe to execute.\n    input_mapping: How parent state maps to child inputs (parent_key -> child_key).\n    output_mapping: How child result maps back to parent state (child_key -> parent_key).",
      "properties": {
        "id": {
          "description": "Unique identifier for the node.",
          "title": "Id",
          "type": "string"
        },
        "council_config": {
          "anyOf": [
            {
              "$ref": "#/$defs/CouncilConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional configuration for architectural triangulation."
        },
        "visual": {
          "anyOf": [
            {
              "$ref": "#/$defs/VisualMetadata"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Visual metadata for the UI."
        },
        "metadata": {
          "additionalProperties": true,
          "description": "Generic metadata for operational context (e.g. cost tracking, SLAs).",
          "title": "Metadata",
          "type": "object"
        },
        "type": {
          "const": "recipe",
          "default": "recipe",
          "description": "Discriminator for RecipeNode.",
          "title": "Type",
          "type": "string"
        },
        "recipe_id": {
          "description": "The ID of the recipe to execute.",
          "title": "Recipe Id",
          "type": "string"
        },
        "input_mapping": {
          "additionalProperties": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "$ref": "#/$defs/DataMapping"
              }
            ]
          },
          "description": "Mapping of parent state keys to child input keys.",
          "title": "Input Mapping",
          "type": "object"
        },
        "output_mapping": {
          "additionalProperties": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "$ref": "#/$defs/DataMapping"
              }
            ]
          },
          "description": "Mapping of child output keys to parent state keys.",
          "title": "Output Mapping",
          "type": "object"
        }
      },
      "required": [
        "id",
        "recipe_id",
        "input_mapping",
        "output_mapping"
      ],
      "title": "RecipeNode",
      "type": "object"
    },
    "RouterExpression": {
      "additionalProperties": false,
      "description": "A structured expression for routing logic (e.g., CEL or JSONLogic).",
      "properties": {
        "operator": {
          "description": "The operator (e.g., 'eq', 'gt').",
          "title": "Operator",
          "type": "string"
        },
        "args": {
          "description": "Arguments for the expression.",
          "items": {},
          "title": "Args",
          "type": "array"
        }
      },
      "required": [
        "operator",
        "args"
      ],
      "title": "RouterExpression",
      "type": "object"
    },
    "StateDefinition": {
      "additionalProperties": false,
      "description": "Defines the internal state (memory) of the Recipe.\n\nAttributes:\n    schema: JSON Schema of the keys available in the shared memory.\n    persistence: Configuration for state durability.",
      "properties": {
        "schema": {
          "additionalProperties": true,
          "description": "JSON Schema of the keys available in the shared memory.",
          "title": "Schema",
          "type": "object"
        },
        "persistence": {
          "default": "ephemeral",
          "description": "Configuration for state durability.",
          "enum": [
            "ephemeral",
            "persistent"
          ],
          "title": "Persistence",
          "type": "string"
        }
      },
      "required": [
        "schema"
      ],
      "title": "StateDefinition",
      "type": "object"
    },
    "VisualMetadata": {
      "additionalProperties": false,
      "description": "Data explicitly for the UI.\n\nAttributes:\n    label: The label to display for the node.\n    x_y_coordinates: The X and Y coordinates for the node on the canvas.\n    icon: The icon to represent the node.\n    animation_style: The animation style for the node.",
      "properties": {
        "label": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "The label to display for the node.",
          "title": "Label"
        },
        "x_y_coordinates": {
          "anyOf": [
            {
              "items": {
                "type": "number"
              },
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "The X and Y coordinates for the node on the canvas.",
          "title": "X Y Coordinates"
        },
        "icon": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "The icon to represent the node.",
          "title": "Icon"
        },
        "animation_style": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "The animation style for the node.",
          "title": "Animation Style"
        }
      },
      "title": "VisualMetadata",
      "type": "object"
    }
  },
  "additionalProperties": false,
  "description": "The executable specification for the MACO engine.\n\nAttributes:\n    id: Unique identifier for the recipe.\n    version: Version of the recipe.\n    name: Human-readable name of the recipe.\n    description: Detailed description of the recipe.\n    interface: Defines the input/output contract for the Recipe.\n    state: Defines the internal state (memory) of the Recipe.\n    parameters: Dictionary of build-time constants.\n    topology: The topology definition of the workflow.\n    integrity_hash: SHA256 hash of the canonical JSON representation of the topology.\n    metadata: Container for design-time data.",
  "properties": {
    "id": {
      "description": "Unique identifier for the recipe.",
      "title": "Id",
      "type": "string"
    },
    "version": {
      "description": "Version of the recipe.",
      "pattern": "^[vV]*(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "title": "Version",
      "type": "string"
    },
    "name": {
      "description": "Human-readable name of the recipe.",
      "title": "Name",
      "type": "string"
    },
    "description": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Detailed description of the recipe.",
      "title": "Description"
    },
    "interface": {
      "$ref": "#/$defs/RecipeInterface",
      "description": "Defines the input/output contract for the Recipe."
    },
    "state": {
      "$ref": "#/$defs/StateDefinition",
      "description": "Defines the internal state (memory) of the Recipe."
    },
    "parameters": {
      "additionalProperties": true,
      "description": "Dictionary of build-time constants.",
      "title": "Parameters",
      "type": "object"
    },
    "topology": {
      "$ref": "#/$defs/GraphTopology",
      "description": "The topology definition of the workflow."
    },
    "integrity_hash": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "SHA256 hash of the canonical JSON representation of the topology. Enforced by Builder, verified by Runtime.",
      "title": "Integrity Hash"
    },
    "metadata": {
      "additionalProperties": true,
      "description": "Container for design-time data (UI coordinates, resolution logs, draft status) to support re-hydration.",
      "title": "Metadata",
      "type": "object"
    }
  },
  "required": [
    "id",
    "version",
    "name",
    "interface",
    "state",
    "parameters",
    "topology"
  ],
  "title": "RecipeManifest",
  "type": "object"
}
